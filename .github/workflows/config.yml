name: Tests

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose

      - name: Run test via docker compose
        id: run-tests
        run: |
          start_time=$(date +%s)  # –§–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
          docker-compose up --exit-code-from regression
          end_time=$(date +%s)    # –§–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
          duration=$((end_time - start_time))
          echo "DURATION_SEC=$duration" >> $GITHUB_OUTPUT
          echo "DURATION_READABLE=$(printf '%02d:%02d:%02d' $((duration/3600)) $(( (duration%3600)/60 )) $((duration%60)))" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Generate Allure report
        if: always()
        run: |
          docker-compose run regression /bin/sh -c "allure generate allure-results --clean -o allure-report"
          mkdir -p allure-results/widgets
          if [ ! -f allure-results/widgets/summary.json ]; then
            echo '{"statistic":{"total":0,"passed":0,"failed":0,"skipped":0}}' > allure-results/widgets/summary.json
          fi
          
      - name: Parse Allure results
        if: always()
        id: allure-stats
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
          if [ ! -f "allure-report/widgets/summary.json" ]; then
            mkdir -p allure-report/widgets
            echo '{"statistic":{"total":0,"passed":0,"failed":0,"skipped":0,"broken":0,"canceled":0}}' > allure-report/widgets/summary.json
          fi

          # –ü–∞—Ä—Å–∏–º —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
          TOTAL=$(jq '.statistic.total // 0' allure-report/widgets/summary.json)
          PASSED=$(jq '.statistic.passed // 0' allure-report/widgets/summary.json)
          FAILED=$(jq '.statistic.failed // 0' allure-report/widgets/summary.json)
          SKIPPED=$(jq '.statistic.skipped // 0' allure-report/widgets/summary.json)
          BROKEN=$(jq '.statistic.broken // 0' allure-report/widgets/summary.json)
          CANCELED=$(jq '.statistic.canceled // 0' allure-report/widgets/summary.json)

          # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
          if [ $TOTAL -gt 0 ]; then
            PASSED_PERCENT=$(( ($PASSED * 100) / $TOTAL ))
            FAILED_PERCENT=$(( ($FAILED * 100) / $TOTAL ))
            SKIPPED_PERCENT=$(( ($SKIPPED * 100) / $TOTAL ))
          else
            PASSED_PERCENT=0
            FAILED_PERCENT=0
            SKIPPED_PERCENT=0
          fi

          echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
          echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
          echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
          echo "SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
          echo "BROKEN=$BROKEN" >> $GITHUB_OUTPUT
          echo "CANCELED=$CANCELED" >> $GITHUB_OUTPUT
          echo "PASSED_PERCENT=$PASSED_PERCENT" >> $GITHUB_OUTPUT
          echo "FAILED_PERCENT=$FAILED_PERCENT" >> $GITHUB_OUTPUT
          echo "SKIPPED_PERCENT=$SKIPPED_PERCENT" >> $GITHUB_OUTPUT  

      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          folder: allure-report
          clean: true

      - name: Send Telegram notification
        if: always()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            <b>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</b>
            
            
            <b>–ü—Ä–æ–µ–∫—Ç:</b> ${{ github.repository }}
            <b>–í–µ—Ç–∫–∞:</b> ${{ github.ref_name }}
            <b>–°—Ç–∞—Ç—É—Å:</b> ${{ steps.run-tests.outcome == 'success' && '‚úÖ –£–°–ü–ï–®–ù–û' || '‚ùå –û–®–ò–ë–ö–ò' }}
            <b>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</b> ${{ steps.run-tests.outputs.DURATION_READABLE }}
            
            
            <b>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b> (${{ steps.allure-stats.outputs.TOTAL }} —Ç–µ—Å—Ç–æ–≤):
            <code>‚îÇ</code> ‚Ä¢ ‚úÖ <b>–£—Å–ø–µ—à–Ω—ã—Ö:</b> ${{ steps.allure-stats.outputs.PASSED }} (${{ steps.allure-stats.outputs.PASSED_PERCENT }}%)
            <code>‚îÇ</code> ‚Ä¢ ‚ùå <b>–£–ø–∞–≤—à–∏—Ö:</b> ${{ steps.allure-stats.outputs.FAILED }} (${{ steps.allure-stats.outputs.FAILED_PERCENT }}%)
            <code>‚îÇ</code> ‚Ä¢ ‚è© <b>–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö:</b> ${{ steps.allure-stats.outputs.SKIPPED }} (${{ steps.allure-stats.outputs.SKIPPED_PERCENT }}%)
            ${{ steps.allure-stats.outputs.BROKEN != '0' && '<code>‚îÇ</code> ‚Ä¢ üõ† <b>–°–ª–æ–º–∞–Ω–Ω—ã—Ö:</b> ' || '' }}${{ steps.allure-stats.outputs.BROKEN != '0' && steps.allure-stats.outputs.BROKEN || '' }}
            
            
            <b>üîó –°—Å—ã–ª–∫–∏</b>:
            <code>‚îÇ</code> ‚Ä¢ <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/">Allure Report</a>
            <code>‚îÇ</code> ‚Ä¢ <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions</a>
            
            
            ${{ steps.run-tests.outcome == 'success' && 'üéâ <b>–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!</b>' || '‚ö†Ô∏è <b>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤!</b>' }}
          format: html
          disable_web_page_preview: true