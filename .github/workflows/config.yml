name: Tests

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose

      - name: Run test via docker compose
        run: |
          docker-compose up --exit-code-from regression
        continue-on-error: true

      - name: Generate Allure report
        if: always()
        run: |
          docker-compose run regression /bin/sh -c "allure generate allure-results --clean -o allure-report"
          mkdir -p allure-results/widgets
          if [ ! -f allure-results/widgets/summary.json ]; then
            echo '{"statistic":{"total":0,"passed":0,"failed":0,"skipped":0}}' > allure-results/widgets/summary.json
          fi
          
      - name: Parse Allure results
        if: always()
        id: allure-stats
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ» Ñ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ÑĞ¼Ğ¸ ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
          if [ ! -f "allure-report/widgets/summary.json" ]; then
            mkdir -p allure-report/widgets
            echo '{"statistic":{"total":0,"passed":0,"failed":0,"skipped":0,"broken":0,"canceled":0}}' > allure-report/widgets/summary.json
          fi

          # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ Ñ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ÑĞ¼Ğ¸
          TOTAL=$(jq '.statistic.total // 0' allure-report/widgets/summary.json)
          PASSED=$(jq '.statistic.passed // 0' allure-report/widgets/summary.json)
          FAILED=$(jq '.statistic.failed // 0' allure-report/widgets/summary.json)
          SKIPPED=$(jq '.statistic.skipped // 0' allure-report/widgets/summary.json)
          BROKEN=$(jq '.statistic.broken // 0' allure-report/widgets/summary.json)
          CANCELED=$(jq '.statistic.canceled // 0' allure-report/widgets/summary.json)

          # Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ñ‹
          if [ $TOTAL -gt 0 ]; then
            PASSED_PERCENT=$(( ($PASSED * 100) / $TOTAL ))
            FAILED_PERCENT=$(( ($FAILED * 100) / $TOTAL ))
            SKIPPED_PERCENT=$(( ($SKIPPED * 100) / $TOTAL ))
          else
            PASSED_PERCENT=0
            FAILED_PERCENT=0
            SKIPPED_PERCENT=0
          fi

          echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
          echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
          echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
          echo "SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
          echo "BROKEN=$BROKEN" >> $GITHUB_OUTPUT
          echo "CANCELED=$CANCELED" >> $GITHUB_OUTPUT
          echo "PASSED_PERCENT=$PASSED_PERCENT" >> $GITHUB_OUTPUT
          echo "FAILED_PERCENT=$FAILED_PERCENT" >> $GITHUB_OUTPUT
          echo "SKIPPED_PERCENT=$SKIPPED_PERCENT" >> $GITHUB_OUTPUT  

      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          folder: allure-report
          clean: true

      - name: Send Telegram notification
        if: always()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            <b>ğŸ“Š Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ñ‚ĞµÑÑ‚Ğ¾Ğ²</b>
            
            <code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</code>
            <b>ĞŸÑ€Ğ¾ĞµĞºÑ‚:</b> ${{ github.repository }}
            <b>Ğ’ĞµÑ‚ĞºĞ°:</b> ${{ github.ref_name }}
            <b>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</b> ${{ steps.run-tests.outcome == 'success' && 'âœ… Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ' || 'âŒ ĞĞ¨Ğ˜Ğ‘ĞšĞ˜' }}
            <code>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</code>
            
            <b>ğŸ“ˆ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</b> (${{ steps.allure-stats.outputs.TOTAL }} Ñ‚ĞµÑÑ‚Ğ¾Ğ²):
            <code>â”‚</code> â€¢ âœ… <b>Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ñ…:</b> ${{ steps.allure-stats.outputs.PASSED }} (${{ steps.allure-stats.outputs.PASSED_PERCENT }}%)
            <code>â”‚</code> â€¢ âŒ <b>Ğ£Ğ¿Ğ°Ğ²ÑˆĞ¸Ñ…:</b> ${{ steps.allure-stats.outputs.FAILED }} (${{ steps.allure-stats.outputs.FAILED_PERCENT }}%)
            <code>â”‚</code> â€¢ â© <b>ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ñ…:</b> ${{ steps.allure-stats.outputs.SKIPPED }} (${{ steps.allure-stats.outputs.SKIPPED_PERCENT }}%)
            ${{ steps.allure-stats.outputs.BROKEN != '0' && '<code>â”‚</code> â€¢ ğŸ›  <b>Ğ¡Ğ»Ğ¾Ğ¼Ğ°Ğ½Ğ½Ñ‹Ñ…:</b> ' || '' }}${{ steps.allure-stats.outputs.BROKEN != '0' && steps.allure-stats.outputs.BROKEN || '' }}
            <code>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</code>
            
            <b>ğŸ”— Ğ¡ÑÑ‹Ğ»ĞºĞ¸</b>:
            <code>â”‚</code> â€¢ <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report">Allure Report</a>
            <code>â”‚</code> â€¢ <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions</a>
            <code>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</code>
            
            ${{ steps.run-tests.outcome == 'success' && 'ğŸ‰ <b>Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!</b>' || 'âš ï¸ <b>Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒĞ¿Ğ°Ğ²ÑˆĞ¸Ñ… Ñ‚ĞµÑÑ‚Ğ¾Ğ²!</b>' }}
          format: html
          disable_web_page_preview: true