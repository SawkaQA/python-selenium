name: Tests

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose

      - name: Run test via docker compose
        run: |
          docker-compose up --exit-code-from regression
        continue-on-error: true

      - name: Generate Allure report
        if: always()
        run: |
          docker-compose run regression /bin/sh -c "allure generate allure-results --clean -o allure-report"
          mkdir -p allure-results/widgets
          if [ ! -f allure-results/widgets/summary.json ]; then
            echo '{"statistic":{"total":0,"passed":0,"failed":0,"skipped":0}}' > allure-results/widgets/summary.json
          fi
          
      - name: Parse Allure results
        if: always()
        id: allure-stats
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

          # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é —Ä–∞–∑–±–∏–≤–∫—É –ø–æ –≤—Å–µ–º —Å—Ç–∞—Ç—É—Å–∞–º
          TOTAL=$(jq '.statistic.total' allure-report/widgets/summary.json || echo 0)
          PASSED=$(jq '.statistic.passed' allure-report/widgets/summary.json || echo 0)
          FAILED=$(jq '.statistic.failed' allure-report/widgets/summary.json || echo 0)
          SKIPPED=$(jq '.statistic.skipped' allure-report/widgets/summary.json || echo 0)
          BROKEN=$(jq '.statistic.broken' allure-report/widgets/summary.json || echo 0)
          CANCELED=$(jq '.statistic.canceled' allure-report/widgets/summary.json || echo 0)

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É–º–º—É
          CALCULATED_TOTAL=$((PASSED + FAILED + SKIPPED + BROKEN + CANCELED))
          if [ $TOTAL -ne $CALCULATED_TOTAL ]; then
            echo "Warning: Total tests ($TOTAL) doesn't match sum of categories ($CALCULATED_TOTAL)" >&2
            TOTAL=$CALCULATED_TOTAL
          fi

          # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã
          if [ $TOTAL -gt 0 ]; then
            PASSED_PERCENT=$(( ($PASSED * 100) / $TOTAL ))
            FAILED_PERCENT=$(( ($FAILED * 100) / $TOTAL ))
            SKIPPED_PERCENT=$(( ($SKIPPED * 100) / $TOTAL ))
          else
            PASSED_PERCENT=0
            FAILED_PERCENT=0
            SKIPPED_PERCENT=0
          fi

          echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
          echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
          echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
          echo "SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
          echo "BROKEN=$BROKEN" >> $GITHUB_OUTPUT
          echo "CANCELED=$CANCELED" >> $GITHUB_OUTPUT
          echo "PASSED_PERCENT=$PASSED_PERCENT" >> $GITHUB_OUTPUT
          echo "FAILED_PERCENT=$FAILED_PERCENT" >> $GITHUB_OUTPUT
          echo "SKIPPED_PERCENT=$SKIPPED_PERCENT" >> $GITHUB_OUTPUT  

      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          folder: allure-report
          clean: true

      - name: Send Telegram notification
        if: always()
        uses: appleboy/telegram-action@v1.0.0
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            <b>üìä–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</b>
            <b>–ü—Ä–æ–µ–∫—Ç</b>: <code>${{ github.repository }}</code>
            <b>–í–µ—Ç–∫–∞</b>: <code>${{ github.ref_name }}</code>
            <b>–°—Ç–∞—Ç—É—Å</b>: ${{ steps.run-tests.outcome == 'success' && '‚úÖ –£–°–ü–ï–®–ù–û' || '‚ùå –û–®–ò–ë–ö–ò' }}

             <b>üìà–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>:
              ‚Ä¢ –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${{ steps.allure-stats.outputs.TOTAL }}
              ‚Ä¢ ‚úÖ –£—Å–ø–µ—à–Ω—ã—Ö: ${{ steps.allure-stats.outputs.PASSED }} (${{ steps.allure-stats.outputs.PASSED_PERCENT }}%)
              ‚Ä¢ ‚ùå –£–ø–∞–≤—à–∏—Ö: ${{ steps.allure-stats.outputs.FAILED }} (${{ steps.allure-stats.outputs.FAILED_PERCENT }}%)
              ‚Ä¢ ‚è© –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö: ${{ steps.allure-stats.outputs.SKIPPED }} (${{ steps.allure-stats.outputs.SKIPPED_PERCENT }}%)
              ‚Ä¢ üõ† –°–ª–æ–º–∞–Ω–Ω—ã—Ö: ${{ steps.allure-stats.outputs.BROKEN }}
              ‚Ä¢ üö´ –û—Ç–º–µ–Ω—ë–Ω–Ω—ã—Ö: ${{ steps.allure-stats.outputs.CANCELED }}

             <b>üîó–°—Å—ã–ª–∫–∏</b>:
              ‚Ä¢ <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report">Allure Report</a>
              ‚Ä¢ <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions</a>

            ${{ steps.run-tests.outcome == 'success' && 'üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!' || '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤!' }}
          format: html
          disable_web_page_preview: true