name: Tests

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose
        run: |
          curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose

      - name: Run test via docker compose
        run: |
          docker-compose up --exit-code-from regression
        continue-on-error: true

      - name: Generate allure-report
        run: |
          docker-compose run regression /bin/sh -c "allure generate allure-results --clean -o allure-report"

      - name: Upload Allure report
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: gh-pages
          folder: allure-report
          clean: true

      - name: Parse Allure results
        if: always()
        id: allure-stats
        run: |
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ jq –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON
          sudo apt-get install -y jq

          # –ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤
          TOTAL=$(jq '.statistic.total' allure-results/widgets/summary.json)
          PASSED=$(jq '.statistic.passed' allure-results/widgets/summary.json)
          FAILED=$(jq '.statistic.failed' allure-results/widgets/summary.json)
          SKIPPED=$(jq '.statistic.skipped' allure-results/widgets/summary.json)

          # –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
          PASSED_PERCENT=$(( ($PASSED * 100) / $TOTAL ))
          FAILED_PERCENT=$(( ($FAILED * 100) / $TOTAL ))

          # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ outputs
          echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
          echo "PASSED=$PASSED" >> $GITHUB_OUTPUT
          echo "FAILED=$FAILED" >> $GITHUB_OUTPUT
          echo "SKIPPED=$SKIPPED" >> $GITHUB_OUTPUT
          echo "PASSED_PERCENT=$PASSED_PERCENT" >> $GITHUB_OUTPUT
          echo "FAILED_PERCENT=$FAILED_PERCENT" >> $GITHUB_OUTPUT


      - name: Notify Telegram chat
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            <b>üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</b>
            <i>–ü—Ä–æ–µ–∫—Ç</i>: <code>${{ github.repository }}</code>
            <i>–í–µ—Ç–∫–∞</i>: <code>${{ github.ref_name }}</code>
            <i>–°—Ç–∞—Ç—É—Å</i>: ${{ steps.run-tests.outcome == 'success' && '‚úÖ –£–°–ü–ï–®–ù–û' || '‚ùå –û–®–ò–ë–ö–ò' }}
            
            üìà <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</b>:
            ‚Ä¢ –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: ${{ steps.allure-stats.outputs.TOTAL }}
            ‚Ä¢ –£—Å–ø–µ—à–Ω—ã—Ö: ${{ steps.allure-stats.outputs.PASSED }} (${{ steps.allure-stats.outputs.PASSED_PERCENT }}%)
            ‚Ä¢ –£–ø–∞–≤—à–∏—Ö: ${{ steps.allure-stats.outputs.FAILED }} (${{ steps.allure-stats.outputs.FAILED_PERCENT }}%)
            ‚Ä¢ –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö: ${{ steps.allure-stats.outputs.SKIPPED }}
            
            üîó <b>–°—Å—ã–ª–∫–∏</b>:
            ‚Ä¢ <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/allure-report">Allure Report</a>
            ‚Ä¢ <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions</a>
            
            ${{ steps.run-tests.outcome == 'success' && 'üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!' || '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤!' }}
          format: html
          disable_web_page_preview: true